\section{The coincidence theorem}
\label{section:equivalence}

Our main theorem is that our operational, denotational and axiomatic preorders for combined probability and nondeterminism all coincide, in both the angelic and demonic cases.
\begin{theorem}[Coincidence theorem] \leavevmode
\begin{enumerate} 
\item The three preorders $\Basicleq^\Op_\prang$, $\Basicleq^\Den_\prang$ and $\Basicleq^\Ax_\prang$, for mixed probability and angelic nondeterminism, coincide.

\item Similarly, the preorders $\Basicleq^\Op_\prdem$, $\Basicleq^\Den_\prdem$ and $\Basicleq^\Ax_\prdem$,
for mixed probability and demonic nondeterminism, coincide.
\end{enumerate}
\end{theorem}

\noindent
We outline the proof of the theorem in the demonic case, which we split into three lemmas. The proof for the angelic case is similar. 
\begin{lemma}
${\Basicleq^\Ax_\prdem} \, \subseteq \, \, \Basicleq^\Op_\prdem\,$.
\end{lemma}
\begin{proof}
 It is easily checked that $\Basicleq^\Op_\prdem$ satsfies the axioms
 of $T_\prdem$.  Since $\Basicleq^\Op_\prdem$ is admissible and 
$\Basicleq^\Ax$ is the smallest admissible model, ${\Basicleq^\Ax_\prdem} \, \subseteq \, \Basicleq^\Op_\prdem\,$.
\end{proof}
%
\noindent
We remark on the following aspect of the above result.
The distributivity axiom Dist of Figure~\ref{fig:axiomsmixed} is sometimes discussed as expressing that  nondeterministic choices  are  resolved before probabilistic ones; see, e.g., \cite{KeimelP2016}. Such statements need careful interpretation. 
The definition of $\Basicleq^\Op_\prdem$, which is based on implementing nondeterministic schedulers as strategies for MDPs,
explicitly allows the  scheduler's choices to take account of the outcomes of probabilistic choices that precede it. Nevertheless, the distributivity axiom is sound.

\begin{lemma}
${\Basicleq^\Op_\prdem} \, = \,\, \Basicleq^\Den_\prdem\,$.
\end{lemma}
\begin{proof}
We make use of the functional representation of $\mathcal{S}\mathcal{V}_{\leq 1}\, \mathbb{N}$ from \cite{KeimelP2016} (see also~\cite{JGL-mscs16}). 
For any topological space $X$, we write $\mathcal{L}(X)$ for the space of all
\emph{lower semicontinuous} functions from $X$ to $[0,\infty]$ (i.e., functions that are continuous with respect to the Scott topology on $[0,\infty]$), and we endow $\mathcal{L}(X)$ itself with the Scott topology. The space
$D' = \mathcal{L}(\mathcal{L}(\mathbb{N}))$ carries a continuous $\Sigma_\prnd$-algebra structure
\[
(F \orEff G)(f) ~ = ~ \min(F(f), G(f)) \qquad 
(F \prEff G)(f) ~ = ~ \frac{1}{2}F(f) + \frac{1}{2}G(f) \enspace .
\]
(There is another $\Sigma_\prnd$-algebra structure, relevant to angelic nondeterminism, in which  $\min$ is replaced with $\max$.) Define $j' : \mathbb{N} \to D'$ by $j'(n)(f) = f(n)$. This induces $\Sem{\cdot}'_\prdem : \Tree(\mathbb{N}) \to D'$
satisfying  $\Sem{\cdot}'_\prdem \circ i = j'$, as in Section~\ref{section:denotational}.
We show that $\Sem{t}'_\prdem (h) = F_h (t)$, where $F_h$ is defined as in
Lemma~\ref{lemma:F-continuous}. For this, the function $t \mapsto (h \mapsto F_h (t)$ is easily shown to be a $\Sigma_\prnd$-algebra homomorphism
satisfying $F_h(i(n)) = j'(n)$. Moreover, it is continuous by 
Lemma~\ref{lemma:F-continuous}. Thus it indeed coincides with 
$\Sem{\cdot}'_\prdem$. By the definition of $F_h$, if follows that that
$t \Basicleq^\Op_\prdem t'$ if and only if 
$\Sem{t}'_\prdem \leq \Sem{t'}'_\prdem \,$.

Corollary 4.7 of \cite{KeimelP2016} provides a functional representation of 
$\mathcal{S}\mathcal{V}_{\leq 1}\, X$ inside $\mathcal{L}(\mathcal{L}(X))$. In the case $X = \mathbb{N}$, consider the function
\[
\Lambda : A \mapsto \left(f \mapsto \inf_{p \in A} 
  \mathbf{E}_p\, f 
% \left( \sum_{n \in \mathbb{N}} f(n)\, . \, p(n) \right)
\right) 
 : \; \mathcal{S}\mathcal{V}_{\leq 1}\, \mathbb{N} \;  \to \; D' \enspace .
\]
It is shown in  \cite{KeimelP2016} that $\Lambda$  is a continuous $\Sigma_\prnd$-algebra homomorphism, and also an order embedding (i.e., $\Lambda(A) \leq \Lambda(B)$ implies $A \supseteq B$). 
%(Furthermore, the image of $\Lambda$ can be characterised as exactly the \emph{superlinear strongly non-expansive} functionals.) 
By the uniqueness property of Proposition~\ref{proposition:free}, it thus holds that $\Lambda \circ \Sem{\cdot}_\prdem = \Sem{\cdot}'_\prdem$. We therefore have
\[
t \Basicleq^\Op_\prdem t' ~~ \Leftrightarrow ~ ~
  \Sem{t}'_\prdem \leq \Sem{t'}'_\prdem 
   ~~ \Leftrightarrow ~ ~
   \Sem{t}_\prdem \leq \Sem{t'}_\prdem 
      ~ ~\Leftrightarrow ~ ~
  t \Basicleq^\Den_\prdem t' \enspace ,
   \]
where the middle equivalence holds because $\Lambda$ is an order embedding.
\end{proof}

\begin{lemma}
\label{lemma:completeness}
${\Basicleq^\Den_\prdem} \, \subseteq \, \, \Basicleq^\Ax_\prdem\,$.
\end{lemma}
\begin{proof}
The proof proceeds in three steps.
    \begin{enumerate}
        \item Prove that both preorders coincide 
            on \emph{probability trees} (i.e., trees without $\orEff$ nodes).
        \item Prove the inclusion of preorders for
             trees with a \emph{finite} number 
            of $\orEff$ nodes.
        \item Use finite approximations and admissibility
            to conclude the general case.
    \end{enumerate}

We omit discussion of the first step, which  is comparatively straightforward.

For step 2, suppose $t \Basicleq^\Den_\prdem t'$ where $t,t'$ are 
trees with finitely many $\orEff$ nodes. For each of $t, t'$, we use the distributivity axiom to rewrite the tree
          as an $\orEff$-combination of finitely many (possibly infinite) {probability trees}. We then establish the following.
    \begin{enumerate}[(a)]
         \item 
            If for every 
            probability
            tree $t_i'$ in $t'$ there exists 
            a corresponding tree $t_i$ in $t$ 
            such that $t_i \Basicleq^\Den_\prdem t_i'$,
            then we have that $t \Basicleq^\Ax_\prdem t'$, using the $\texttt{Dem}$ axiom, and  step 1 above.

        \item 
            %If $t_i$ and $t_j$ are two  of the probability trees of $t$,
            The tree $t$ is equivalent  in both preorders  to 
            $t \orEff k$, where $k = \lambda_1t_1+ \dots + \lambda_n t_n$
            is any tree representing a convex combination of the probability trees of $t$.
            The tree $k$ is defined  using infinite combinations of $\prEff$ nodes to assign the correct weight to each $t_i$.
    
        \item Making direct use of the definition of $\mathcal{S}\mathcal{V}_{\leq 1}\, \mathbb{N}$, it follows from $t \Basicleq^\Den_\prdem t'$ that, for every
            probability tree   $t_i'$ of $t'$,
            there is a convex combination
            $k_i := \lambda_1t_1+ \dots + \lambda_n t_n$
            of probability trees of $t$,
                        such that $k_i \Basicleq^\Den_\prdem t_i'$.


  
      \end{enumerate}
To complete the argument for step 2, the  tree $t'$ has the form $t'_1 \orEff \dots \orEff t'_m$. By (c), there exist corresponding  $k_1, \dots, k_m$. By (b), $t$ is equivalent to
$t \orEff k_1 \orEff \dots \orEff k_m$. It now follows from (a) that $t \Basicleq^\Ax_\prdem t'$,
by the property of the $k_j$ given by (c).


For step 3, suppose 
$t \Basicleq^\Den_\prdem t'$, where $t,t'$ are arbitrary.
Take approximating sequences  $t = \bigsqcup_i t_i$ and $t' = \bigsqcup_i t_i'$,
    where both ascending sequences are composed of {finite} trees.

We use Definition~\ref{def:probaApproxConstruct} to further restrict the approximations of $t$.
Using the finiteness of $t_i$,
we have $\Sem{\Iter{t_i}{n}}_\prdem \ll \Sem{t_i}_\prdem$ in the way-below relation 
on $\mathcal{S}\mathcal{V}_{\leq 1} \mathbb{N}$, via the explicit characterisation of this relation in~\cite{KeimelP2016}. Also, $(\Iter{t_i}{i})$ is an ascending sequence 
of finite trees with $\bigsqcup_i \Iter{t_i}{i} = \Iter{t}{\infty}$
% $ \simeq_\prdem t$.

%So $(\Sem{\Iter{t_i}{i}}_\prdem)$ is an ascending sequence in 
%$\mathcal{S}\mathcal{V}_{\leq 1} \mathbb{N}$ with 
For every $i$, we have 
$\Sem{\Iter{t_i}{i}}_\prdem \ll  \Sem{t_i}_\prdem \leq \Sem{t}_\prdem \leq \Sem{t'}_\prdem$. That is $\Sem{\Iter{t_i}{i}}_\prdem \ll  \Sem{t'}_\prdem$. 
Since $\Sem{t'}_\prdem = \bigsqcup \Sem{t_i'}_\prdem$, it follows from the way-below property that, for every $i$, 
$\Sem{\Iter{t_i}{i}}_\prdem \leq \Sem{t'_{j_i}}_\prdem$ for some $j_i$, where the sequence
 $(j_i)$ can be assumed strictly ascending.
So, by step 2 above, 
$\Iter{t_i}{i} \Basicleq^\Ax_\prdem t'_{j_i}$, for every $i$.
Whence by admissibility, 
$\bigsqcup_i \Iter{t_i}{i} \Basicleq^\Ax_\prdem  \bigsqcup_i t'_{j_i}$; i.e.,
$\Iter{t}{\infty}  \Basicleq^\Ax_\prdem  t'$. 
Thus $t \Basicleq^\Ax_\prdem  t'$, by Proposition~\ref{proposition:horn}.
 \end{proof}

